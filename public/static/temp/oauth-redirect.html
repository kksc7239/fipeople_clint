<script src="./axios.min.js"></script>
<script>
    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};
        if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
        n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;s=b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t,s)}(window, document,'script',
        'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '724013908349278');
    fbq('track', 'PageView');
</script>
<noscript><img height="1" width="1" style="display:none"
               src="https://www.facebook.com/tr?id=724013908349278&ev=PageView&noscript=1"
/></noscript>

<script>
    var apiUrl = 'https://pipeople.club';

    var params = {};
    window.location.search.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(str, key, value) { params[key] = value; });
    if(!opener){
        var data = JSON.parse(decodeURIComponent(params.data));
        if(data.isNew === true) { // 회원가입으로 보낸다
            axios.post('/api/auth/oauth-kakao-join', {
                id : data.id,
                state : data.state,
                name : data.name || null,
                gender : data.gender || null,
                email : data.email || null,
                ref : data.ref || null,
                image : data.image && data.image.key || null,
            }).then((reponse) => {
                localStorage.setItem("loginYn", true);
                localStorage.setItem("accessToken", reponse.data.accessToken);
                localStorage.setItem("refreshToken", reponse.data.refreshToken);
                localStorage.setItem("name", reponse.data.name);
                localStorage.setItem("email", reponse.data.email);
                localStorage.setItem("image", apiUrl+reponse.data.image.publicPath);
                window.fbq('track', 'CompleteRegistration');
                location.replace('/');
            })
        }else { // 가입이미 된상태 토큰바로 만든다
            localStorage.setItem("loginYn", true);
            localStorage.setItem("accessToken", data.accessToken);
            localStorage.setItem("refreshToken", data.refreshToken);
            localStorage.setItem("name", data.name);
            localStorage.setItem("email", data.email);
            localStorage.setItem("image", apiUrl+data.image.publicPath);
        }
    } else {
        opener.popupMessage(JSON.parse(decodeURIComponent(params.data)));
        window.close();
    }

</script>